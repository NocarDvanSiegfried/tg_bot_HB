#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è production-—Å–±–æ—Ä–∫–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –≤ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/build-frontend-static.sh

set -e

echo "üî® –ù–∞—á–∏–Ω–∞–µ–º production-—Å–±–æ—Ä–∫—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."

cd frontend

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ node_modules
if [ ! -d "node_modules" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
    npm ci
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ VITE_API_URL
if [ -z "$VITE_API_URL" ]; then
    echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: VITE_API_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è VITE_API_URL –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π"
    echo "   –ü—Ä–∏–º–µ—Ä: export VITE_API_URL=https://api.micro-tab.ru:9443"
    exit 1
fi

echo "‚úÖ VITE_API_URL: $VITE_API_URL"

# –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–±–æ—Ä–∫—É
echo "üßπ –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–±–æ—Ä–∫—É..."
rm -rf dist

# –í—ã–ø–æ–ª–Ω—è–µ–º production-—Å–±–æ—Ä–∫—É
echo "üî® –í—ã–ø–æ–ª–Ω—è–µ–º production-—Å–±–æ—Ä–∫—É..."
npm run build

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ ! -d "dist" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ø–∞–ø–∫–∞ dist –Ω–µ —Å–æ–∑–¥–∞–Ω–∞!"
    exit 1
fi

if [ ! -f "dist/index.html" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ dist!"
    exit 1
fi

echo "‚úÖ Production-—Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "üìÅ –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤: frontend/dist"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ frontend/dist –≤ /var/www/miniapp –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
echo "   2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ /var/www/miniapp"
echo "   3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ nginx: sudo systemctl reload nginx"

