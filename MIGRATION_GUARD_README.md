# Migration Guard Handler - Временный защитный обработчик

## Назначение

`migration_guard_handler.py` - временный обработчик, созданный для предотвращения ошибки `BOT_RESPONSE_TIMEOUT` при нажатии на старые InlineKeyboard кнопки в истории чата пользователей после миграции на архитектуру "Bot = launcher, Mini App = application".

## Проблема

После удаления всех CRUD handlers (birthday_*, panel_*, responsible_*, greeting_*) в истории чата пользователей остались старые сообщения с InlineKeyboard кнопками. При нажатии на эти кнопки:

1. Telegram отправляет `CallbackQuery` с устаревшим `callback_data`
2. Бот не имеет handler'а для этого `callback_data`
3. Telegram ждет ответ 30 секунд
4. Возникает `BOT_RESPONSE_TIMEOUT` (код 400)

## Решение

Migration guard handler:

- ✅ Ловит **любой** `CallbackQuery`, для которого нет специализированного handler'а
- ✅ Мгновенно отвечает на callback (`callback.answer()`), чтобы Telegram не ждал 30 секунд
- ✅ Возвращает короткое уведомление: "Функция больше недоступна. Используйте Mini App."
- ✅ Не содержит CRUD-логики
- ✅ Не взаимодействует с БД
- ✅ Не меняет состояние приложения
- ✅ Не возвращает UI, панели или клавиатуры

## Архитектурные гарантии

**Handler НЕ нарушает архитектуру "Bot = launcher":**

- ❌ Не обрабатывает CRUD-операции (только отвечает на callback)
- ❌ Не восстанавливает `/panel` или старые кнопки
- ❌ Не добавляет FSM или бизнес-логику
- ✅ Mini App остается единственным местом для CRUD
- ✅ `/start` остается единственной точкой входа
- ✅ Бот остается launcher'ом

**Handler изолирован:**

- Отдельный файл: `migration_guard_handler.py`
- Явно помечен как временный (комментарии в коде)
- Легко удаляется после миграции

## Регистрация

Handler регистрируется **ПОСЛЕ** всех специализированных handlers:

```python
# Порядок важен:
dp.include_router(start_handler.router)  # Специализированные handlers первыми
dp.include_router(migration_guard_handler.router)  # Catch-all handler последним
```

Это гарантирует, что migration guard ловит только те callback'и, которые не обработаны другими handlers.

## Мониторинг

Handler логирует все обработанные callback'и:

```
[Migration Guard] Получен callback от старой кнопки: callback_data=..., user_id=...
```

Это позволяет:
- Отслеживать использование старых кнопок
- Определить, когда можно удалить handler
- Понять, сколько пользователей еще используют старые сообщения

## Удаление handler'а

**Когда можно удалить:**

- Через **N недель** после полной миграции пользователей
- Когда логи показывают, что старые кнопки больше не используются
- Когда все пользователи удалили старые сообщения

**Как удалить:**

1. Удалить файл `backend/src/presentation/telegram/handlers/migration_guard_handler.py`
2. Удалить импорт из `backend/src/presentation/telegram/handlers/__init__.py`
3. Удалить регистрацию из `backend/src/presentation/telegram/bot.py` и `backend/main.py`
4. Обновить документацию

**После удаления:**

- Пользователи должны удалить старые сообщения вручную
- Новые пользователи не имеют проблемы (видят только `/start` с WebApp-кнопкой)
- `BOT_RESPONSE_TIMEOUT` вернется для пользователей со старыми сообщениями, но это ожидаемо

## Альтернативные решения (почему они не подходят)

### ❌ Не добавлять handler вообще

**Проблема:** Пользователи видят `BOT_RESPONSE_TIMEOUT` при нажатии на старые кнопки, что создает плохой UX.

### ❌ Автоматически удалять старые сообщения

**Проблема:** Telegram API не предоставляет механизма для программного удаления сообщений ботом без знания `message_id`.

### ❌ Восстановить старые handlers

**Проблема:** Нарушает архитектуру "Bot = launcher", создает технический долг, возвращает CRUD-логику в бот.

## Текущее решение - компромисс

Migration guard handler - это **временный компромисс** между:

- ✅ Чистой архитектурой (не обрабатывает CRUD)
- ✅ Хорошим UX (нет `BOT_RESPONSE_TIMEOUT`)
- ✅ Легкостью удаления (изолирован в отдельном файле)

Handler **не нарушает архитектуру**, потому что:
- Не выполняет бизнес-логику
- Не обрабатывает CRUD-операции
- Только отвечает на callback для предотвращения timeout
- Легко удаляется после миграции

## Статус

**Текущий статус:** ✅ Активен (временный)

**Планируемое удаление:** Через N недель после полной миграции пользователей

**Мониторинг:** Логи показывают использование старых кнопок

---

**Версия:** 1.0.0  
**Создан:** 2025-01-XX  
**Планируемое удаление:** 2025-XX-XX (через N недель)

