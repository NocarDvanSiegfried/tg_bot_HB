---
alwaysApply: true
---

# Database & Migration Standards

## Core Principles
- The database layer must never contain business logic.
- All business rules must live in the domain layer.
- The application and domain layers must depend only on repository interfaces, not concrete database implementations.
- The database schema must reflect domain invariants but must not drive business logic.

---

## Repository & Data Access Rules
- Repositories must operate only through defined interfaces.
- No direct SQL/ORM calls inside controllers or use-cases.
- Repositories must:
    - accept domain-friendly input (ids, filters, value objects)
    - return mapped domain models or controlled DTOs
    - perform only minimal data transformation
- No leaking database entities or ORM models outside the infrastructure layer.

---

## Data Mapping Rules
- ORM / query builder / raw SQL results must always be mapped into:
    - domain entities (when needed by business logic)
    - application DTOs (when needed for output)
- No exposing internal database fields directly to the upper layers.
- No implicit casting or type guessing.

---

## Database Schema Rules
- Schema must be stable and explicit:
    - explicit column types
    - explicit constraints
    - explicit indexes where required
- No hidden or auto-created schema elements.
- Column names must follow project naming conventions.
- Relationships must be defined clearly (1-to-1, 1-to-many, many-to-many).

---

## Database Constraints
- Constraints must enforce domain rules:
    - NOT NULL for required fields
    - UNIQUE for unique properties
    - CHECK constraints for validated ranges
    - FOREIGN KEYS for relationships
- Business invariants must be enforced both:
    - at domain level
    - at schema level

---

## Query Rules
- Queries must be:
    - parameterized
    - safe
    - optimized
    - predictable
- No dynamic SQL.
- No inline string concatenations.
- No unbounded SELECT * queries unless necessary.

---

## Migrations Requirements
- All schema changes must go through explicit migrations.
- No automatic ORM schema generation in production.
- Migrations must be:
    - versioned
    - incremental
    - irreversible by default or reversible only when safe
    - stored in the repository under a dedicated /migrations folder

---

## Migration Workflow
Each migration must follow this workflow:

1. Define schema changes in a new migration file.
2. Include both:
    - upward changes (apply)
    - downward changes (rollback) *if rollback is allowed*
3. Run migrations locally before committing.
4. Ensure migrations reflect domain constraints.
5. Ensure migrations do not break existing data unexpectedly.

---

## Migration Rules
- Never modify an existing migration after it is applied anywhere.
- For changes, always create a new migration.
- No merging multiple unrelated schema updates into one migration.
- No storing temporary or experiment migrations in the main branch.

---

## Data Integrity Rules
- Never delete or rewrite data automatically during migrations unless explicitly required.
- Destructive migrations must:
    - be documented
    - be isolated
    - require explicit confirmation

---

## Database Interaction Boundaries
- Infrastructure layer is the only place allowed to:
    - run queries
    - handle transactions
    - manage connections
- Use-cases may request operations through repository interfaces only.
- Domain layer must not know that a database even exists.

---

## Transactions
- Multi-step operations must use transactions.
- Transactions must be handled only in the infrastructure layer.
- Use-cases initiate transactional workflows indirectly via repository interfaces.
- No nested transactions unless supported and intentional.

---

## Performance & Indexing
- Indexes must be defined for all frequently queried fields.
- No redundant or duplicate indexes.
- Periodic schema review must ensure:
    - unused indexes are removed
    - necessary indexes are added
- Avoid N+1 query patterns by design:
    - use joins
    - use batching patterns

---

## Clean Architecture Compliance
- Domain layer: zero database references.
- Application layer: depends only on repository interfaces.
- Infrastructure layer: implements repositories using SQL/ORM.
- Presentation layer: never touches database or ORM.

---

