# План исправления проблем с сессиями БД и отображением

## Цель
Исправить проблемы с множественными сессиями БД и улучшить обработку ошибок на frontend, чтобы редактирование и удаление дней рождения работали корректно.

## Проблемы для исправления

### Критические (блокируют работу):
1. Множественные сессии БД в одном запросе
2. Неправильный порядок зависимостей FastAPI

### Высокий приоритет:
3. `get_readonly_use_case_factory` создаёт свою сессию
4. `require_panel_access` не может использовать существующую сессию

### Средний приоритет:
5. Ошибка не отображается пользователю в форме
6. Возможна гонка состояний при обновлении списка

---

## Шаг 1: Унифицировать использование сессий БД

### Задача 1.1: Изменить `get_readonly_use_case_factory` для поддержки существующей сессии

**Файл**: `backend/src/presentation/web/dependencies.py`

**Изменения**:
- Добавить опциональный параметр `session: AsyncSession | None = None` в `get_readonly_use_case_factory`
- Если сессия передана, использовать её; иначе создавать новую
- Изменить сигнатуру функции для поддержки dependency injection с существующей сессией

**Ожидаемый результат**:
- `get_readonly_use_case_factory` может использовать существующую сессию
- Обратная совместимость сохранена (если сессия не передана, создаётся новая)

---

### Задача 1.2: Изменить `require_panel_access` для использования существующей сессии

**Файл**: `backend/src/presentation/web/routes/api.py`

**Изменения**:
- Изменить `require_panel_access` так, чтобы он принимал опциональную сессию через dependency injection
- Если сессия передана, использовать её для создания фабрики; иначе использовать `get_readonly_use_case_factory()` без параметров
- Изменить порядок параметров: сначала `session`, затем `factory`, затем `user`

**Ожидаемый результат**:
- `require_panel_access` может использовать существующую сессию
- Обратная совместимость сохранена для endpoints, которые не передают сессию

---

### Задача 1.3: Изменить порядок зависимостей в `update_birthday` и `delete_birthday`

**Файл**: `backend/src/presentation/web/routes/api.py`

**Изменения**:
- Изменить порядок зависимостей в `update_birthday`:
  1. `session: AsyncSession = Depends(get_db_session)` - создаётся первым
  2. `factory: UseCaseFactory = Depends(get_use_case_factory)` - использует сессию из шага 1
  3. `user: dict = Depends(require_panel_access)` - использует сессию из шага 1
- Аналогично для `delete_birthday`

**Ожидаемый результат**:
- Все операции в одном запросе используют одну и ту же сессию БД
- Коммит происходит в той же сессии, где выполняются операции

---

## Шаг 2: Исправить обработку ошибок на frontend

### Задача 2.1: Убрать `throw error` из `handleUpdate`

**Файл**: `frontend/src/components/Panel/BirthdayManagement.tsx`

**Изменения**:
- Убрать `throw error` из `handleUpdate` (строка 219)
- Ошибка уже обработана и отображена через `setError`, пробрасывать её не нужно

**Ожидаемый результат**:
- Ошибки корректно отображаются пользователю
- Нет лишних пробросов ошибок

---

### Задача 2.2: Добавить обработку ошибок в `onSubmit` формы

**Файл**: `frontend/src/components/Panel/BirthdayManagement.tsx`

**Изменения**:
- В `onSubmit` формы (строка 333-337) добавить обработку ошибок с отображением через `setError`
- Убедиться, что ошибка отображается пользователю, а не только логируется

**Ожидаемый результат**:
- Пользователь видит ошибки, возникающие при отправке формы
- Ошибки не теряются в логах

---

## Шаг 3: Улучшить надёжность frontend

### Задача 3.1: Добавить проверку на размонтирование компонента

**Файл**: `frontend/src/components/Panel/BirthdayManagement.tsx`

**Изменения**:
- Добавить `useRef` для отслеживания состояния монтирования компонента
- В `useEffect` установить флаг монтирования
- В `loadBirthdays` проверять флаг перед обновлением состояния
- В cleanup `useEffect` сбросить флаг

**Ожидаемый результат**:
- Нет ошибок "Can't perform a React state update on an unmounted component"
- Состояние не обновляется после размонтирования

---

### Задача 3.2: Улучшить ключи React для списка

**Файл**: `frontend/src/components/Panel/BirthdayManagement.tsx`

**Изменения**:
- В `birthdays.map((bd) => (...))` использовать безопасный ключ: `key={bd.id ?? `birthday-${index}`}`
- Или добавить проверку на `bd.id` перед рендерингом элемента

**Ожидаемый результат**:
- React корректно отслеживает элементы списка
- Состояние редактирования не "прилипает" к неправильному элементу

---

## Шаг 4: Тестирование

### Задача 4.1: Проверить редактирование дня рождения

**Действия**:
1. Открыть панель управления
2. Нажать "Редактировать" на любом дне рождения
3. Изменить данные и нажать "Сохранить"
4. Проверить, что изменения сохранились в БД
5. Проверить логи backend - должна быть одна сессия для всего запроса

**Ожидаемый результат**:
- Изменения сохраняются корректно
- В логах видна одна сессия для всего запроса
- Нет ошибок в консоли браузера

---

### Задача 4.2: Проверить удаление дня рождения

**Действия**:
1. Открыть панель управления
2. Нажать "Удалить" на любом дне рождения
3. Подтвердить удаление
4. Проверить, что запись удалена из БД
5. Проверить логи backend - должна быть одна сессия для всего запроса

**Ожидаемый результат**:
- Запись удаляется корректно
- В логах видна одна сессия для всего запроса
- Нет ошибок в консоли браузера

---

### Задача 4.3: Проверить обработку ошибок

**Действия**:
1. Открыть панель управления
2. Попытаться отредактировать день рождения с невалидными данными
3. Проверить, что ошибка отображается пользователю
4. Проверить логи frontend и backend

**Ожидаемый результат**:
- Ошибки отображаются пользователю
- Ошибки логируются корректно
- Нет необработанных исключений

---

## Порядок выполнения

1. **Шаг 1** (критический) - унифицировать использование сессий БД
2. **Шаг 2** (высокий) - исправить обработку ошибок на frontend
3. **Шаг 3** (средний) - улучшить надёжность frontend
4. **Шаг 4** (тестирование) - проверить все исправления

---

## Критерии успеха

✅ Все операции редактирования и удаления используют одну сессию БД  
✅ Изменения корректно сохраняются в БД  
✅ Ошибки отображаются пользователю  
✅ Нет ошибок в консоли браузера  
✅ Нет ошибок в логах backend  
✅ Нет предупреждений React о размонтированных компонентах  

---

## Откат изменений

Если что-то пойдёт не так:
1. Откатить изменения в `backend/src/presentation/web/dependencies.py`
2. Откатить изменения в `backend/src/presentation/web/routes/api.py`
3. Откатить изменения в `frontend/src/components/Panel/BirthdayManagement.tsx`
4. Проверить, что приложение работает как до изменений

