# –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø—Ä–∏—á–∏–Ω—ã 502 Bad Gateway

**–î–∞—Ç–∞:** 2025-01-19  
**–°—Ç–∞—Ç—É—Å:** –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞

---

## –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –∏–∑ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **Backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω:**
   - –°—Ç–∞—Ç—É—Å: `Up 5 minutes`
   - –ü–æ—Ä—Ç –ø—Ä–æ–±—Ä–æ—à–µ–Ω: `0.0.0.0:8000->8000/tcp`

2. **Backend –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ health check:**
   ```bash
   curl http://localhost:8000/health
   # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {"status":"ok","service":"Telegram Birthday Calendar API","message":"API is running"}
   ```

3. **Backend —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8000:**
   ```
   tcp  0.0.0.0:8000  LISTEN
   ```

### üî¥ –ü—Ä–æ–±–ª–µ–º—ã:

1. **Telegram Bot Conflict:**
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ `TelegramConflictError` –≤ –ª–æ–≥–∞—Ö
   - –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å updates –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ —Å –¥—Ä—É–≥–∏–º —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–º

2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–æ–≤ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞:**
   - –í –ª–æ–≥–∞—Ö –ù–ï–¢ —Å–æ–æ–±—â–µ–Ω–∏–π "Uvicorn running on" –∏–ª–∏ "Application startup complete"
   - –í—Å–µ –ª–æ–≥–∏ –∑–∞–Ω—è—Ç—ã –æ—à–∏–±–∫–∞–º–∏ –±–æ—Ç–∞

---

## –ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏

### –ü–∞—Ä–∞–¥–æ–∫—Å:

**Backend –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ `curl http://localhost:8000/health`**, –Ω–æ nginx –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 502 Bad Gateway.

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:
- ‚úÖ –í–µ–±-—Å–µ—Ä–≤–µ—Ä –ó–ê–ü–£–©–ï–ù –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Backend –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `localhost:8000`
- ‚ùå Nginx –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ backend

### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã 502:

1. **Nginx –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ backend:**
   - –ï—Å–ª–∏ nginx —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Docker, –∞ backend –Ω–∞ —Ö–æ—Å—Ç–µ - –Ω—É–∂–µ–Ω –¥—Ä—É–≥–æ–π –∞–¥—Ä–µ—Å
   - –ï—Å–ª–∏ nginx –Ω–∞ —Ö–æ—Å—Ç–µ - –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å `127.0.0.1:8000`

2. **–ü—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ç—å—é –º–µ–∂–¥—É nginx –∏ backend:**
   - Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
   - –ü—Ä–æ–±–ª–µ–º—ã —Å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π

3. **Backend –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ nginx:**
   - –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
   - –ü—Ä–æ–±–ª–µ–º—ã —Å SSL/TLS
   - –¢–∞–π–º–∞—É—Ç—ã

4. **Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è:**
   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π proxy_pass
   - –ü—Ä–æ–±–ª–µ–º—ã —Å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
   - –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ—Ä—Ç–∞–º–∏

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–∏–ø–æ—Ç–µ–∑

### –ì–∏–ø–æ—Ç–µ–∑–∞ 1: Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Docker, backend –Ω–∞ —Ö–æ—Å—Ç–µ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- –ï—Å–ª–∏ nginx –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, `127.0.0.1:8000` –±—É–¥–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ localhost –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ nginx, –∞ –Ω–µ —Ö–æ—Å—Ç–∞
- –ù—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `host.docker.internal:8000` –∏–ª–∏ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞

**–†–µ—à–µ–Ω–∏–µ:**
–ò–∑–º–µ–Ω–∏—Ç—å `nginx/conf.d/backend.conf`:
```nginx
proxy_pass http://host.docker.internal:8000;
```

### –ì–∏–ø–æ—Ç–µ–∑–∞ 2: Nginx –Ω–∞ —Ö–æ—Å—Ç–µ, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ—Ç –ª–∏ nginx –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
curl -v http://127.0.0.1:8000/health

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ nginx
tail -f /var/log/nginx/backend_error.log
```

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
- Backend –Ω–µ —Å–ª—É—à–∞–µ—Ç –Ω–∞ `127.0.0.1` (–Ω–æ —Å–ª—É—à–∞–µ—Ç –Ω–∞ `0.0.0.0`, —á—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å)
- Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç
- SELinux –±–ª–æ–∫–∏—Ä—É–µ—Ç (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω)

### –ì–∏–ø–æ—Ç–µ–∑–∞ 3: –ü—Ä–æ–±–ª–µ–º—ã —Å SSL/TLS

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- Nginx –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SSL –Ω–∞ –ø–æ—Ä—Ç—É 9443
- Backend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ HTTP (–ø–æ—Ä—Ç 8000)
- –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è reverse proxy

**–ù–æ:** –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏, nginx –º–æ–∂–µ—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∏–ª–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã.

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≥–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç nginx

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ nginx –≤ Docker
docker ps | grep nginx

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ nginx –Ω–∞ —Ö–æ—Å—Ç–µ
systemctl status nginx
# –∏–ª–∏
ps aux | grep nginx
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ nginx

```bash
# –ï—Å–ª–∏ nginx –≤ Docker
docker compose logs nginx --tail 100

# –ï—Å–ª–∏ nginx –Ω–∞ —Ö–æ—Å—Ç–µ
tail -f /var/log/nginx/backend_error.log
tail -f /var/log/nginx/error.log
```

**–ß—Ç–æ –∏—Å–∫–∞—Ç—å:**
- "connect() failed (111: Connection refused)"
- "upstream timed out"
- "no live upstreams"
- "SSL certificate" –æ—à–∏–±–∫–∏

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å backend –∏–∑ nginx

```bash
# –ï—Å–ª–∏ nginx –≤ Docker, –∑–∞–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å
docker exec -it <nginx-container> curl http://127.0.0.1:8000/health
# –∏–ª–∏
docker exec -it <nginx-container> curl http://host.docker.internal:8000/health

# –ï—Å–ª–∏ nginx –Ω–∞ —Ö–æ—Å—Ç–µ
curl http://127.0.0.1:8000/health
```

### 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
nginx -t

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∫–∞–∫–∏–µ —Å–µ—Ä–≤–µ—Ä—ã —Å–ª—É—à–∞—é—Ç
netstat -tuln | grep -E "8001|9443"
```

### 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ—Ç–≤–µ—á–∞–µ—Ç –ª–∏ backend –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ nginx

```bash
# –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∫ backend (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å)
curl http://localhost:8000/health

# –ó–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ nginx (–º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å)
curl -k https://api.micro-tab.ru:9443/health
# –∏–ª–∏
curl -k https://localhost:9443/health
```

---

## –ù–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞

**–°—É–¥—è –ø–æ –¥–∞–Ω–Ω—ã–º:**

1. Backend —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ `localhost:8000` ‚úÖ
2. Nginx –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 502 ‚ùå
3. –í –ª–æ–≥–∞—Ö –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ nginx ‚ùì

**–ù–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ:**
- Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ö–æ—Å—Ç–µ (–Ω–µ –≤ Docker)
- Nginx –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ backend –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ
- –ò–ª–∏ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è

**–ù–æ:** –ï—Å–ª–∏ `curl http://localhost:8000/health` —Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ nginx –Ω–∞ —Ö–æ—Å—Ç–µ —Ç–æ–∂–µ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å —Å `127.0.0.1:8000`.

**–í–æ–∑–º–æ–∂–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
- Nginx –ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ `127.0.0.1:8000`, –Ω–æ backend —Å–ª—É—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
- –ò–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å SSL/TLS –ø—Ä–∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–∏

---

## –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ nginx

```bash
tail -50 /var/log/nginx/backend_error.log
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é nginx

```bash
nginx -t
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å nginx

```bash
nginx -s reload
# –∏–ª–∏
systemctl reload nginx
```

### –®–∞–≥ 4: –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å

```bash
# –ò–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ nginx (–µ—Å–ª–∏ –≤ Docker)
docker exec -it <nginx-container> curl http://host.docker.internal:8000/health

# –° —Ö–æ—Å—Ç–∞
curl http://127.0.0.1:8000/health
```

---

## –í—ã–≤–æ–¥—ã

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:

- ‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –æ—Ç–≤–µ—á–∞–µ—Ç
- ‚ùå Nginx –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 502
- ‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –≥–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç nginx (Docker –∏–ª–∏ —Ö–æ—Å—Ç)

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

1. **–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –≥–¥–µ —Ä–∞–±–æ—Ç–∞–µ—Ç nginx** (Docker –∏–ª–∏ —Ö–æ—Å—Ç)
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ nginx** –¥–ª—è —Ç–æ—á–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã 502
3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å backend –∏–∑ nginx** (curl –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∏–ª–∏ —Å —Ö–æ—Å—Ç–∞)
4. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é** –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –ø—Ä–∏—á–∏–Ω—ã

---

**–°—Ç–∞—Ç—É—Å:** –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ nginx  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ nginx –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –≥–¥–µ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç

