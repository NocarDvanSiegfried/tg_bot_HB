# –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã 502 Bad Gateway

**–î–∞—Ç–∞:** 2025-01-19  
**–°—Ç–∞—Ç—É—Å:** –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω—ã

---

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **Backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω:**
   - –°—Ç–∞—Ç—É—Å: `Up 5 minutes`
   - –ü–æ—Ä—Ç –ø—Ä–æ–±—Ä–æ—à–µ–Ω: `0.0.0.0:8000->8000/tcp`

2. **Backend –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ health check:**
   ```bash
   curl http://127.0.0.1:8000/health
   # –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {"status":"ok","service":"Telegram Birthday Calendar API","message":"API is running"}
   ```

3. **Backend —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 8000:**
   ```
   tcp  0.0.0.0:8000  LISTEN
   ```

4. **Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —Ö–æ—Å—Ç–µ:**
   - –°—Ç–∞—Ç—É—Å: `active (running)`
   - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞

### üî¥ –ü—Ä–æ–±–ª–µ–º—ã:

1. **–í –ª–æ–≥–∞—Ö nginx –æ—à–∏–±–∫–∏:**
   ```
   connect() failed (111: Connection refused) while connecting to upstream
   upstream: "http://127.0.0.1:8000/"
   ```

2. **–í –ª–æ–≥–∞—Ö backend –ù–ï–¢ —Å–æ–æ–±—â–µ–Ω–∏–π –æ –∑–∞–ø—É—Å–∫–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞:**
   - –ù–µ—Ç "Uvicorn running on"
   - –ù–µ—Ç "Application startup complete"
   - –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏ Telegram –±–æ—Ç–∞

3. **Telegram Bot Conflict:**
   - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫ `TelegramConflictError`
   - –î—Ä—É–≥–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω

4. **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–•–û–î–ö–ê –≤ –ª–æ–≥–∞—Ö nginx:**
   ```
   2025/12/12 03:03:57 [crit] 3392344#3392344: *1918 mkdir() "/var/lib/nginx/proxy/7/01" 
   failed (28: No space left on device)
   ```
   **–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –º–µ—Å—Ç–æ!**

---

## –ö–û–†–ù–ï–í–ê–Ø –ü–†–ò–ß–ò–ù–ê

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ—Ö–≤–∞—Ç–∫–∞ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ (–ö–†–ò–¢–ò–ß–ù–û)

**–û—à–∏–±–∫–∞ –≤ –ª–æ–≥–∞—Ö nginx:**
```
[crit] mkdir() "/var/lib/nginx/proxy/7/01" failed (28: No space left on device)
```

**–í–ª–∏—è–Ω–∏–µ:**
- Nginx –Ω–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è
- –≠—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–∂–µ—Ç –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ 502 Bad Gateway

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Telegram Bot Conflict

**–û—à–∏–±–∫–∞:**
```
TelegramConflictError: Conflict: terminated by other getUpdates request
```

**–í–ª–∏—è–Ω–∏–µ:**
- –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å updates
- –ú–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
- –ù–æ –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–ª–∏—è—Ç—å –Ω–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –í–µ–±-—Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è

**–í –ª–æ–≥–∞—Ö –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ –∑–∞–ø—É—Å–∫–µ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞:**
- –í–æ–∑–º–æ–∂–Ω–æ, –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞
- –ò–ª–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –Ω–æ –Ω–µ –ª–æ–≥–∏—Ä—É–µ—Ç

---

## –†–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: –û—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ (–ö–†–ò–¢–ò–ß–ù–û)

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞:**
```bash
df -h
```

**–û—á–∏—Å—Ç–∏—Ç—å –º–µ—Å—Ç–æ:**
```bash
# –û—á–∏—Å—Ç–∏—Ç—å Docker –ª–æ–≥–∏
docker system prune -a --volumes

# –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏ nginx
sudo truncate -s 0 /var/log/nginx/*.log

# –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker container prune

# –û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
docker image prune -a
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã:**
```bash
du -sh /var/log/* | sort -h
du -sh /var/lib/nginx/* | sort -h
```

### –†–µ—à–µ–Ω–∏–µ 2: –û—Ç–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞ (–ë–´–°–¢–†–û–ï –†–ï–®–ï–ù–ò–ï)

**–ò–∑–º–µ–Ω–∏—Ç—å .env:**
```env
ENABLE_TELEGRAM_BOT=false
```

**–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å:**
```bash
docker compose restart backend
```

### –†–µ—à–µ–Ω–∏–µ 3: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –∑–∞–ø—É—Å–∫–∞ (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í–µ–±-—Å–µ—Ä–≤–µ—Ä –∏ –±–æ—Ç –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –Ω–æ –±–æ—Ç –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –±–æ—Ç–∞ (—Å–º. –∫–æ–¥ –Ω–∏–∂–µ).

---

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã):

1. **–û—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ:**
   ```bash
   df -h
   docker system prune -a --volumes
   sudo truncate -s 0 /var/log/nginx/*.log
   ```

2. **–û—Ç–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞:**
   ```bash
   # –í .env —Ñ–∞–π–ª–µ
   ENABLE_TELEGRAM_BOT=false
   
   # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å
   docker compose restart backend
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞:**
   ```bash
   docker compose logs backend --tail 100 | grep -i "uvicorn\|started\|running\|web"
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:**
   ```bash
   curl http://127.0.0.1:8000/health
   curl -k https://api.micro-tab.ru:9443/health
   ```

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ (–¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã):

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –∑–∞–ø—É—Å–∫–∞:**
   - –°–¥–µ–ª–∞—Ç—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º –æ—Ç –±–æ—Ç–∞
   - –û–±–µ—Å–ø–µ—á–∏—Ç—å, —á—Ç–æ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¥–∞–∂–µ –µ—Å–ª–∏ –±–æ—Ç –ø–∞–¥–∞–µ—Ç

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤:**
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å logrotate –¥–ª—è nginx
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ Docker –ª–æ–≥–æ–≤

3. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –±–æ—Ç–∞:**
   - –ù–∞–π—Ç–∏ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥—Ä—É–≥–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä
   - –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤–º–µ—Å—Ç–æ polling

---

## –í—ã–≤–æ–¥—ã

### –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ 502 Bad Gateway:

**–û–°–ù–û–í–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê:** –ù–µ—Ö–≤–∞—Ç–∫–∞ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ (`No space left on device`)

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- Telegram Bot Conflict (–º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞)
- –í–æ–∑–º–æ–∂–Ω–æ, –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –±–æ—Ç–∞

### –†–µ—à–µ–Ω–∏–µ:

1. **–ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ:** 
   - –û—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ
   - –û—Ç–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞ (`ENABLE_TELEGRAM_BOT=false`)

2. **–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ:** 
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –∑–∞–ø—É—Å–∫–∞, —á—Ç–æ–±—ã –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–ª—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –±–æ—Ç–∞
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç –±–æ—Ç–∞

---

**–°—Ç–∞—Ç—É—Å:** –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π  
**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –û—Å–≤–æ–±–æ–¥–∏—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ –∏ –æ—Ç–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞

