# План исправления проблемы 502 Bad Gateway

**Дата:** 2025-01-19  
**Приоритет:** Критический

---

## Корневая причина

**ОСНОВНАЯ ПРОБЛЕМА:** Нехватка места на диске (`No space left on device`)

**Дополнительные проблемы:**
1. Telegram Bot Conflict (другой экземпляр бота запущен)
2. Веб-сервер может не запускаться из-за ошибок бота
3. Nginx не может создавать временные файлы для проксирования

---

## План исправления

### Шаг 1: Освободить место на диске (КРИТИЧНО)

**Команды для выполнения на сервере:**

```bash
# 1. Проверить использование диска
df -h

# 2. Очистить Docker логи и неиспользуемые ресурсы
docker system prune -a --volumes

# 3. Очистить старые логи nginx
sudo truncate -s 0 /var/log/nginx/access.log
sudo truncate -s 0 /var/log/nginx/error.log
sudo truncate -s 0 /var/log/nginx/backend_error.log

# 4. Очистить старые Docker контейнеры
docker container prune -f

# 5. Очистить неиспользуемые образы
docker image prune -a -f

# 6. Проверить большие файлы
du -sh /var/log/* | sort -h | tail -10
du -sh /var/lib/nginx/* | sort -h | tail -10
du -sh /var/lib/docker/* | sort -h | tail -10

# 7. Проверить использование диска после очистки
df -h
```

**Ожидаемый результат:**
- Освобождено достаточно места на диске (минимум 10% свободного места)
- Nginx может создавать временные файлы

---

### Шаг 2: Отключить бота временно

**Изменить .env файл:**

```env
ENABLE_TELEGRAM_BOT=false
```

**Перезапустить backend:**

```bash
docker compose restart backend
```

**Проверить логи:**

```bash
docker compose logs backend --tail 50 | grep -i "uvicorn\|started\|running\|web\|server"
```

**Ожидаемый результат:**
- В логах видны сообщения о запуске веб-сервера
- Нет ошибок Telegram бота
- Backend отвечает на health check

---

### Шаг 3: Проверить доступность

**Проверить backend напрямую:**

```bash
curl http://127.0.0.1:8000/health
```

**Проверить через nginx:**

```bash
curl -k https://api.micro-tab.ru:9443/health
```

**Проверить логи nginx:**

```bash
tail -f /var/log/nginx/backend_error.log
```

**Ожидаемый результат:**
- Backend отвечает на прямые запросы
- Backend отвечает через nginx
- Нет ошибок в логах nginx

---

### Шаг 4: Исправить код запуска (РЕКОМЕНДУЕТСЯ)

**Проблема:** Веб-сервер и бот запускаются параллельно, но бот может блокировать запуск веб-сервера.

**Решение:** Изменить `backend/main.py` чтобы веб-сервер запускался независимо от бота.

**Изменения в `backend/main.py`:**

```python
async def main():
    """Главная функция запуска."""
    # ... (существующий код проверки переменных окружения) ...
    
    # ВСЕГДА запускаем веб-сервер независимо от бота
    logger.info("Запуск веб-сервера...")
    web_task = asyncio.create_task(start_web())
    
    # Даем веб-серверу время запуститься
    await asyncio.sleep(2)
    
    # Проверяем, что веб-сервер запустился
    if web_task.done():
        error = web_task.exception()
        if error:
            logger.error(f"Веб-сервер завершился с ошибкой: {error}")
            raise error
        else:
            logger.error("Веб-сервер завершился сразу после запуска!")
            raise RuntimeError("Веб-сервер не запустился")
    
    logger.info("✅ Веб-сервер запущен")
    
    # Запускаем бота отдельно, если включен
    enable_bot = os.getenv("ENABLE_TELEGRAM_BOT", "true").lower() in ("true", "1", "yes")
    
    if enable_bot:
        logger.info("Запуск Telegram бота...")
        try:
            await start_bot()
        except Exception as e:
            logger.error(f"Бот не запущен: {e}, но веб-сервер продолжает работать")
            # Веб-сервер продолжает работать независимо
    else:
        logger.info("Telegram бот отключен через ENABLE_TELEGRAM_BOT=false")
    
    # Ждем завершения веб-сервера (он должен работать бесконечно)
    try:
        await web_task
    except Exception as e:
        logger.error(f"Веб-сервер завершился с ошибкой: {e}")
        raise
```

**Ожидаемый результат:**
- Веб-сервер запускается независимо от бота
- Веб-сервер продолжает работать даже если бот падает
- В логах видны сообщения о запуске веб-сервера

---

### Шаг 5: Настроить ротацию логов (РЕКОМЕНДУЕТСЯ)

**Создать файл `/etc/logrotate.d/nginx-tg-bot`:**

```
/var/log/nginx/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0640 www-data adm
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

**Настроить ограничение размера Docker логов в `docker-compose.yml`:**

```yaml
services:
  backend:
    # ... (существующая конфигурация) ...
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

**Ожидаемый результат:**
- Логи автоматически ротируются
- Не накапливаются большие файлы логов
- Диск не заполняется логами

---

### Шаг 6: Исправить конфликт бота (если нужен бот)

**Проблема:** Другой экземпляр бота уже запущен.

**Решения:**

1. **Найти и остановить другой экземпляр:**
   ```bash
   # Найти процессы Python, которые могут быть ботом
   ps aux | grep python | grep -i bot
   
   # Найти Docker контейнеры с ботом
   docker ps -a | grep bot
   
   # Остановить найденные процессы/контейнеры
   ```

2. **Использовать webhook вместо polling:**
   - Настроить webhook для бота
   - Это предотвратит конфликты при нескольких экземплярах

3. **Отключить бота, если не нужен:**
   - Установить `ENABLE_TELEGRAM_BOT=false` в .env

---

## Порядок выполнения

1. ✅ **Шаг 1:** Освободить место на диске (КРИТИЧНО)
2. ✅ **Шаг 2:** Отключить бота временно
3. ✅ **Шаг 3:** Проверить доступность
4. ⚠️ **Шаг 4:** Исправить код запуска (если шаги 1-3 не помогли)
5. ⚠️ **Шаг 5:** Настроить ротацию логов (для предотвращения проблемы в будущем)
6. ⚠️ **Шаг 6:** Исправить конфликт бота (если нужен бот)

---

## Проверка успешности исправления

**Критерии успеха:**

1. ✅ На диске достаточно свободного места (минимум 10%)
2. ✅ Backend отвечает на `curl http://127.0.0.1:8000/health`
3. ✅ Backend отвечает через nginx на `curl -k https://api.micro-tab.ru:9443/health`
4. ✅ В логах backend видны сообщения о запуске веб-сервера
5. ✅ Нет ошибок "No space left on device" в логах nginx
6. ✅ Нет ошибок "Connection refused" в логах nginx

---

**Статус:** План готов к выполнению  
**Приоритет:** Критический  
**Следующий шаг:** Выполнить Шаг 1 (освободить место на диске)

